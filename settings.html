<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSRP | Settings</title>
    <link rel="icon" type="image/webp" href="https://cdn.discordapp.com/icons/1198422904178749500/6bfeee54c636ac47d339a198ff6843d2.webp">
    <style>
        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .bg-blur { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: url('https://cdn.discordapp.com/attachments/1423737735159484537/1462698389459439687/Screenshot_2026-01-19_at_1.40.06_AM.png?ex=6973c0c7&is=69726f47&hm=c6190bbb0efec04d0d16cf86db54ce4a5822e8f0936a68f9f8d8f66f1076b030&'); background-size: cover; background-position: center; filter: blur(10px); transform: scale(1.1); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); z-index: 0; }
        .settings-card { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 18px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); width: 100%; max-width: 500px; position: relative; z-index: 1; text-align: center; }
        h1 { font-size: 2rem; margin-bottom: 20px; color: #222; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 25px; font-size: 1.3rem; text-align: left; }
        .section { margin-bottom: 25px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1rem; }
        .btn-save { background: #007bff; color: white; }
        .btn-2fa { background: #28a745; color: white; }
        .btn-disable { background: #6c757d; color: white; margin-top: 10px; }
        .btn-delete { background: #dc3545; color: white; margin-top: 15px; }
        .status-active { background: #e7f3ef; color: #28a745; padding: 15px; border-radius: 10px; font-weight: bold; display: none; }
        .qr-container { text-align: center; margin: 20px 0; display: none; }
        #qr-code img { max-width: 150px; border: 4px solid white; }
        .back-link { display: block; text-align: left; margin-bottom: 15px; color: #007bff; text-decoration: none; font-weight: 600; }
        .center-text { text-align: center; }
    </style>
</head>
<body>
<div class="bg-blur"></div>
<div class="overlay"></div>
<div class="settings-card">
    <a href="/dashboard" class="back-link">&larr; Return to Dashboard</a>
    <h1>Account Settings</h1>
    <div class="section">
        <h2>Change Password</h2>
        <input type="password" id="old-pass" placeholder="Current Password">
        <input type="password" id="new-pass" placeholder="New Password">
        <button class="btn btn-save" onclick="changePassword()">Update Password</button>
    </div>
    <div class="section">
        <h2>Two-Factor Authentication (RECOMMENDED)</h2>
        <h4>Mandatory for SHR+</h4>
        <button id="setup-2fa-btn" class="btn btn-2fa" onclick="setup2FA()">Enable 2FA</button>
        <div id="2fa-active-msg" class="status-active">
            âœ“ 2FA is currently enabled
            <button class="btn btn-disable" onclick="disable2FA()">Disable 2FA</button>
        </div>
        <div id="qr-container" class="qr-container">
            <div id="qr-code"></div>
            <input type="text" id="2fa-token" placeholder="Enter 6-digit code">
            <button class="btn btn-save" onclick="verify2FA()">Verify and Save</button>
        </div>
    </div>
    <div>
        <h2 class="center-text" style="color: #dc3545;">DANGER ZONE</h2>
        <button class="btn btn-delete" onclick="deleteAccount()">Delete Account</button>
        <p>Website Made and Managed by the MSRP Development Team</p>
    </div>
</div>
<script>
    async function checkStatus() {
        const res = await fetch('/api/me');
        const data = await res.json();
        if (data.twoFactorEnabled) {
            document.getElementById('setup-2fa-btn').style.display = 'none';
            document.getElementById('2fa-active-msg').style.display = 'block';
        }
    }
    checkStatus();

    async function setup2FA() {
        const res = await fetch('/api/settings/2fa/setup', { method: 'POST' });
        const data = await res.json();
        document.getElementById('qr-code').innerHTML = `<img src="${data.qrCode}">`;
        document.getElementById('qr-container').style.display = 'block';
        document.getElementById('setup-2fa-btn').style.display = 'none';
    }

    async function verify2FA() {
        const token = document.getElementById('2fa-token').value;
        const res = await fetch('/api/settings/2fa/verify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({token})
        });
        if(res.ok) location.reload();
        else alert("Invalid code.");
    }

    async function disable2FA() {
        if(confirm("Are you sure?")) {
            await fetch('/api/settings/2fa/disable', { method: 'POST' });
            location.reload();
        }
    }

    async function changePassword() {
        const oldPass = document.getElementById('old-pass').value;
        const newPass = document.getElementById('new-pass').value;
        const res = await fetch('/api/settings/password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({oldPass, newPass})
        });
        alert(await res.text());
    }

    async function deleteAccount() {
        if(confirm("Permanently delete account?")) {
            await fetch('/api/settings/account', { method: 'DELETE' });
            window.location.href = '/';
        }
    }
</script>
</body>
</html>
