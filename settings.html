<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSRP | Settings</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        .bg-blur {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-image: url('https://cdn.discordapp.com/attachments/1423737735159484537/1462698389459439687/Screenshot_2026-01-19_at_1.40.06_AM.png?ex=6973c0c7&is=69726f47&hm=c6190bbb0efec04d0d16cf86db54ce4a5822e8f0936a68f9f8d8f66f1076b030&');
            background-size: cover;
            background-position: center;
            filter: blur(10px);
            transform: scale(1.1);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 0;
        }

        .settings-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 500px;
            position: relative;
            z-index: 1;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
        }

        h1 { font-size: 2rem; margin-bottom: 20px; color: #222; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 25px; font-size: 1.3rem; text-align: left; }
        
        .section { margin-bottom: 25px; }
        
        input { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            box-sizing: border-box;
            font-size: 1rem;
        }

        .btn { 
            padding: 14px; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: bold; 
            width: 100%; 
            font-size: 1rem;
            transition: opacity 0.2s, transform 0.1s;
        }

        .btn-save { background: #007bff; color: white; }
        .btn-2fa { background: #28a745; color: white; }
        .btn-delete { background: #dc3545; color: white; margin-top: 15px; }
        
        .status-active { 
            background: #e7f3ef; 
            color: #28a745; 
            padding: 12px; 
            border-radius: 10px; 
            font-weight: bold;
            display: none;
        }

        .qr-container { text-align: center; margin: 20px 0; display: none; }
        #qr-code img { max-width: 180px; border: 5px solid white; border-radius: 10px; }

        .back-link {
            display: block;
            text-align: left;
            margin-bottom: 15px;
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
        }
    </style>
</head>
<body>

<div class="bg-blur"></div>
<div class="overlay"></div>

<div class="settings-card">
    <a href="/dashboard" class="back-link">&larr; Back to Dashboard</a>
    <h1>Account Settings</h1>

    <div class="section">
        <h2>Change Password</h2>
        <input type="password" id="old-pass" placeholder="Current Password">
        <input type="password" id="new-pass" placeholder="New Password">
        <button class="btn btn-save" onclick="changePassword()">Update Password</button>
    </div>

    <div class="section">
        <h2>Two-Factor Authentication</h2>
        <p id="2fa-desc" style="font-size:0.9rem; color:#666;">Secure your account with a mobile authenticator app.</p>
        
        <button id="setup-2fa-btn" class="btn btn-2fa" onclick="setup2FA()">Enable 2FA</button>
        
        <div id="2fa-active-msg" class="status-active">âœ“ 2FA is currently enabled</div>

        <div id="qr-container" class="qr-container">
            <p style="font-size:0.85rem; margin-bottom:10px;">Scan this QR code with Google Authenticator:</p>
            <div id="qr-code"></div>
            <input type="text" id="2fa-token" placeholder="Enter 6-digit code">
            <button class="btn btn-save" onclick="verify2FA()">Verify and Save</button>
        </div>
    </div>

    <div class="section" style="border-top: 2px solid #fee; padding-top: 15px;">
        <h2 style="color: #dc3545;">Danger Zone</h2>
        <button class="btn btn-delete" onclick="deleteAccount()">Permanently Delete Account</button>
    </div>
</div>

<script>
    // NEW: Check 2FA status on page load
    async function checkStatus() {
        const res = await fetch('/api/me');
        if (res.ok) {
            const data = await res.json();
            if (data.twoFactorEnabled) {
                document.getElementById('setup-2fa-btn').style.display = 'none';
                document.getElementById('2fa-active-msg').style.display = 'block';
                document.getElementById('2fa-desc').innerText = "Your account is protected by 2FA.";
            }
        }
    }
    checkStatus();

    async function changePassword() {
        const oldPass = document.getElementById('old-pass').value;
        const newPass = document.getElementById('new-pass').value;
        if (!oldPass || !newPass) return alert("Please fill in both fields.");
        const res = await fetch('/api/settings/password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({oldPass, newPass})
        });
        alert(await res.text());
    }

    async function setup2FA() {
        const res = await fetch('/api/settings/2fa/setup', { method: 'POST' });
        const data = await res.json();
        document.getElementById('qr-code').innerHTML = `<img src="${data.qrCode}">`;
        document.getElementById('qr-container').style.display = 'block';
        document.getElementById('setup-2fa-btn').style.display = 'none';
    }

    async function verify2FA() {
        const token = document.getElementById('2fa-token').value;
        const res = await fetch('/api/settings/2fa/verify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({token})
        });
        if(res.ok) {
            alert("2FA Enabled Successfully!");
            location.reload();
        } else {
            alert("Invalid Token.");
        }
    }

    async function deleteAccount() {
        if(confirm("Are you absolutely sure?")) {
            const res = await fetch('/api/settings/account', { method: 'DELETE' });
            if(res.ok) window.location.href = '/';
        }
    }
</script>

</body>
</html>
