<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSRP | Admin Panel</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .bg-fixed {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background-image: url('https://cdn.discordapp.com/attachments/1423737735159484537/1462698389459439687/Screenshot_2026-01-19_at_1.40.06_AM.png?ex=6973c0c7&is=69726f47&hm=c6190bbb0efec04d0d16cf86db54ce4a5822e8f0936a68f9f8d8f66f1076b030&');
            background-size: cover;
            background-position: center;
            filter: blur(15px);
            transform: scale(1.1);
        }

        .main-content {
            position: relative;
            z-index: 1;
            padding: 40px 20px;
        }

        .container {
            max-width: 1100px;
            margin: auto;
            background: rgba(255, 255, 255, 0.97);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #dee2e6; color: #444; }
        td { padding: 12px; border-bottom: 1px solid #eee; }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
        }
        .badge-owner { background: #dc3545; }
        .badge-admin { background: #28a745; }
        .badge-staff { background: #007bff; }
        .badge-user { background: #6c757d; }
        .badge-banned { background: #000; }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.75rem;
            margin: 2px;
            transition: 0.2s;
        }
        .btn-promote { background: #28a745; color: white; }
        .btn-demote { background: #fd7e14; color: white; }
        .btn-ban { background: #343a40; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-nav { background: #007bff; color: white; text-decoration: none; padding: 10px 15px; }

        .btn:hover { opacity: 0.8; }
    </style>
</head>
<body>

<div class="bg-fixed"></div>

<div class="main-content">
    <div class="container">
        <header>
            <div>
                <h1 style="margin:0;">Management Portal</h1>
                <span id="my-info" style="font-size: 0.8rem; color: #666;"></span>
            </div>
            <nav>
                <a href="/dashboard" class="btn-nav" style="border-radius: 6px;">Dashboard</a>
                <a href="/logout" class="btn-nav" style="background:#6c757d; border-radius: 6px;">Logout</a>
            </nav>
        </header>

        <table>
            <thead>
                <tr>
                    <th>User</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="user-table-body">
                </tbody>
        </table>
    </div>
</div>

<script>
    let myRole = '';
    let myName = '';

    async function init() {
        const res = await fetch('/api/me');
        const data = await res.json();
        myRole = data.role;
        myName = data.username;
        document.getElementById('my-info').innerText = `Authorized: ${myName} (${myRole})`;
        fetchUsers();
    }

    async function fetchUsers() {
        const res = await fetch('/api/users');
        const users = await res.json();
        const tbody = document.getElementById('user-table-body');
        tbody.innerHTML = '';

        users.forEach(user => {
            if (user.username === myName) return;

            const row = document.createElement('tr');
            const roleClass = `badge-${user.role.toLowerCase()}`;
            const statusLabel = user.isBanned ? '<span class="badge badge-banned">Banned</span>' : '<span class="badge" style="background:#e1f6e5; color:#28a745;">Active</span>';

            let actionsHtml = '';
            
            // Promotion
            if (user.role === 'User' && (myRole === 'Admin' || myRole === 'Owner')) {
                actionsHtml += `<button class="btn btn-promote" onclick="manage('promote', '${user.username}')">Promote to Staff</button>`;
            } else if (user.role === 'Staff' && myRole === 'Owner') {
                actionsHtml += `<button class="btn btn-promote" onclick="manage('promote', '${user.username}')">Promote to Admin</button>`;
            }

            // Demotion
            if (user.role === 'Staff' && (myRole === 'Admin' || myRole === 'Owner')) {
                actionsHtml += `<button class="btn btn-demote" onclick="manage('demote', '${user.username}')">Demote to Member</button>`;
            } else if (user.role === 'Admin' && myRole === 'Owner') {
                actionsHtml += `<button class="btn btn-demote" onclick="manage('demote', '${user.username}')">Demote to Staff</button>`;
            }

            // Ban/Delete
            const canManage = myRole === 'Owner' || (myRole === 'Admin' && (user.role === 'User' || user.role === 'Staff'));
            if (canManage && user.role !== 'Owner') {
                actionsHtml += `<button class="btn btn-ban" onclick="manage('ban', '${user.username}')">${user.isBanned ? 'Unban' : 'Ban'}</button>`;
                actionsHtml += `<button class="btn btn-delete" onclick="manage('delete', '${user.username}')">Delete</button>`;
            }

            row.innerHTML = `
                <td><strong>${user.username}</strong></td>
                <td><span class="badge ${roleClass}">${user.role}</span></td>
                <td>${statusLabel}</td>
                <td>${actionsHtml}</td>
            `;
            tbody.appendChild(row);
        });
    }

    async function manage(action, username) {
        const method = action === 'delete' ? 'DELETE' : 'POST';
        const res = await fetch(`/api/${action}-user/${username}`, { method });
        if (res.ok) fetchUsers();
        else alert("Action failed.");
    }

    init();
</script>

</body>
</html>
